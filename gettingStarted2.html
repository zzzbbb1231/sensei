---
layout: default
title: SenseiBA - Getting Started, Part Two
name: getting-started2
---
<div class="hero-unit">
	<h2>Pushing the data into the cluster </h2>
</div>
	<p>
		In the previous part we've learned how to push the data into the SenseiBA node running in the standalone mode. For a big cluster this approach is not viable, we can not copy csv files across servers in the datacenter.
The segment is pushed to the cluster via http. Once the segment is uploaded to a signle SenseiBA node, it would atomatically be assigned to one of the partitions. This information is saved to zookeeper. All  other Sensei nodes are subscribed to zookeeper
 changes. Once they receive the notification that the new segment arrived, they would pull the data from the initial node. Here is the diagram:
<p>
	<img border="1" src="images/ba_indexing-diagram.png">
</p>
<h2>Prerequisites</h2>
<p>
		The SenseiBA is installed. Pointing to $SENSEIBA_HOME
</p>

<h2>Steps: </h2>
<br>
<div class="row">
	<div class="span6">
		<h3>Step 1: Building the index offline</h3>
		<p>
		 In the previous tutorial we've downloaded the 1987.csv file containing the departure/arrival stats. Let's build the SenseiBA segment out of it. 
		</p>
	</div>
	<div class="span10">
		<br>
               <p>
		Run the command:
		<pre><code>$SENSEIBA_HOME/bin/build-segment.sh seg_1987 1987.csv .</code></pre>
		</p>
		<p>
			<ul>
                         <li>seg_1987 is the name of the segment we want to generate.</li> 
	                 <li>1987.csv is the path to csv/tsv/json/avro file you want to index</li> 
                         <li>. is the directory where the output index should be placed</li> 
		     </ul>
 
		</p>
                <p>
                     You can specify some additional properties
        		<ul>
                         <li>--exclude= comma separated list of excluded columns</li> 
	                 <li>--sort= comma separated list of columns we want to sort. Primary and secondary sorts affects how quickly the document can be located by the filtering term</li> 
		     </ul>

                </p> 
                 <p>The seg_1987.tar.gz file should be created for you in the working dir. It's essentially the indexed version of 1987.csv</p>   
	</div>
</div>
<div class="row">
	<div class="span6">
		<h3>Step 2: Start Zookeeper</h3>
		<p>
		Zookeeper manages SenseiBA&apos;s network topology or cluster.
		</p>
	</div>
	<div class="span10">
		<p>
		Start your Zookeeper instance: (You can start your own Zookeeper cluster by following instructions <a href="http://zookeeper.apache.org/doc/trunk/zookeeperStarted.html">here</a>), From <code>$SENSEIBA_HOME</code>
		<pre><code>./bin/zookeeper-server-start.sh config/zookeeper.properties</code></pre>
		</p>
		<p>
			You can shut it down by running:
			<pre><code>./bin/zookeeper-server-stop.sh</code></pre>
		</p>
	</div>
</div>

<div class="row">
	<div class="span6">
		<h3>Step 2: Start SenseiBA Node</h3>
		<p>
		 With Zookeeper running, we can start a Sensei node serving  SenseiBA node listening on port 8080:
		</p>
	</div>
	<div class="span10">
		<p>
		In <code>$SENSEIBA_HOME</code>, start your SenseiBA node by pointing to the <a href="https://github.com/sensei-ba/sensei/blob/master/sensei-ba/config-example/src/main/resources/config" target="_blank">Cluster example configuration directory</a>:
		<pre><code>./bin/start-sensei-node.sh examples/config</code></pre>
		</p>
		
	</div>
</div>
<div class="row">
	<div class="span6">
		<h3>Step 3: Uploading the segment</h3>
		<p>
		Now it's time to ingest some data
		</p>
	</div>
	<div class="span10">
		<p>
		Point your favorite browser to: <a href="http://localhost:8080">http://localhost:8080</a>. To make sure that theSenseiBA is running
		</p>
                 <p>
		Let's upload the segment via http:
		<pre><code>curl -F seg_1987=@seg_1987.tar.gz http://localhost:8089/files</code></pre>
		</p>
		 <p>
		Now we can check whether the upload is succesful. Go to <a href="http://localhost:8089/segments/">http://localhost:8089/segments/</a>. You can see smth like this:
		<pre>{
 "0": {},
 "1": {"seg_1987": {
  "pathUrl": ["http://172.16.56.114:8089/files/seg_1987"],
  "segment.index.version": "001",
  "segmentId": "seg_1987",
  "timeCreated": "1357598362160"
 }},
 "2": {},
 "3": {},
 "4": {},
 "5": {},
 "6": {},
 "7": {}
}</pre>
	This shows, that seg_1987 was assigned to the partition 1. And it can be downloaded via the path http://x.x.x.x:8089/files/seg_1987

</p>
<p>
		Let's also go to the web console: <a href="http://localhost:8080">http://localhost:8080</a>. And run the query:
<pre><code>select distinctCount(Origin)</code></pre>
		</p>
            <p>You should see 10 matching documents in the response along with the distinctCount result at the bottom
	</div>
</div>
<div class="row">
	<div class="span6">
		<h3>Step 4: Deleting the segment</h3>
		<p>
		  Shortly we would add a section about the fancy segment management UI. Meanwhile we can use rest commands
		</p>
	</div>
	<div class="span10">
		<p>
		
		<pre><code>http://localhost:8089/segments/1/seg_1987?move=2</code> would move the segment to the partition 2</pre> 
		</p>
                <p>
		
		<pre><code>http://localhost:8089/segments/1/seg_1987?delete</code> will delete the segment</pre> 
		</p>
		
	</div>
</div>
<br><br>
<div class="row">
	<div class="span6">
		<h3>Step 5: Tips for distributed deployment</h3>
		<p>
		  This section will answer how to deploy SenseiBA in the distributed way
		</p>
	</div>
	<div class="span10">
		<p>
		
		Let's deploy two SenseiBA nodes that will be a part of a single cluster. This deployment needs to happen on two separate machines
		</p>
                <p>
		
		The deployment would be based on the following  <a href="https://github.com/sensei-ba/sensei/blob/master/sensei-ba/config-example/src/main/resources/config/sensei.properties">sensei.properties</a>  
		  
                 </p>
 <p>On each node  make sure that <pre><code>sensei.search.cluster.zookeeper.url</code> </pre> points to the same url</code> </pre> </p>

                <p>
                For node1 change <pre><code>sensei.node.partitions</code></pre> to value <pre><code>0-3</code></pre>
                </p>
		<p>
                For node2 change <pre><code>sensei.node.partitions</code></pre> to value <pre><code>4-7</code></pre>
                </p>
                <p>
                For node2 we also need to modify the<pre><code>sensei.node.id</code> to value <code>2</code></pre>
                </p> 
                <p>
                    Now we are ready to start two SenseiBA search instances by running <pre><code>./bin/start-sensei-node.sh examples/config</code></pre>
                </p>
	</div>
</div>

